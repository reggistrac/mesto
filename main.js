(()=>{"use strict";function e(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class t{constructor(t,s,r,o,n,i){e(this,"_handleClick",(()=>{this._showImgPopup(this._subscribe,this._source)})),e(this,"_handlelike",(e=>{this._likeing(this._data,this._userId).then((t=>{e.target.parentElement.nextElementSibling.textContent=t.likes.length,e.target.classList.toggle("element__buttonlike_liked"),this._data.likes=t.likes})).catch((e=>{alert("likeing\n"+e)}))})),e(this,"_handleTrash",(e=>{this._showPoupSure(e.target.closest(".element"),this._id)})),this._data=t,this._subscribe=t.title,this._source=t.link,this._owner=t.owner._id,this._id=t._id,this._likes=t.likes,this._selector=s,this._userId=r,this._showImgPopup=o,this._showPoupSure=n,this._likeing=i}_getTemplate(){return document.querySelector(this._selector).content.cloneNode(!0)}_setEventListener(e,t,s){e.addEventListener(t,s)}createCard(){const e=this._getTemplate();e.querySelector(".element__text").textContent=this._subscribe;const t=e.querySelector(".element__img");this._setEventListener(t,"click",this._handleClick),t.src=this._source,t.alt=this._subscribe;const s=e.querySelector(".element__buttonlike");this._setEventListener(s,"click",this._handlelike),e.querySelector(".element__count").textContent=this._likes.length;const r=this._userId;this._likes.some((function(e){return e._id===r}))&&s.firstElementChild.classList.toggle("element__buttonlike_liked");const o=e.querySelector(".element__buttontrash");return this._setEventListener(o,"click",this._handleTrash),this._owner!==this._userId?(console.log(this._owner),o.style.display="none"):console.log(this._owner+" Моё"),e}}class s{constructor(e,t){this._settings=e,this._form=t,this._inputList=Array.from(this._form.querySelectorAll(this._settings.inputSelector)),this._button=this._form.querySelector(this._settings.submitButtonSelector)}resetError(){const e=Array.from(this._form.querySelectorAll(this._settings.errorSpanSelector));this._form.reset(),e.forEach((e=>{e.classList.remove(this._settings.errorClass)}))}_hasInvalidInput(){return this._inputList.every((function(e){return e.validity.valid}))}_checkInputValidity(e){const t=document.querySelector(`#${e.name}Error`);e.validity.valid?t.classList.remove(this._settings.errorClass):(t.textContent=e.validationMessage,t.classList.add(this._settings.errorClass))}toggleButton(){this._hasInvalidInput()?(this._button.removeAttribute("disabled"),this._button.classList.remove(this._settings.inactiveButtonClass)):(this._button.setAttribute("disabled","true"),this._button.classList.add(this._settings.inactiveButtonClass))}_setEventListeners(){this.toggleButton(),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this.toggleButton()}))}))}enableValidation(){this._form.addEventListener("submit",(function(e){e.preventDefault()})),this._setEventListeners()}}function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class o{constructor(e){r(this,"_closeByEsc",(e=>{"Escape"===e.key&&this.closePopup()})),r(this,"_close",(e=>{(e.target.classList.contains("close")||e.target.classList.contains("popup"))&&this.closePopup()})),this._popup=e}setEventListeners(){this._popup.addEventListener("mousedown",this._close)}showPopup(){document.addEventListener("keydown",this._closeByEsc),this._popup.classList.add("opened")}closePopup(){document.removeEventListener("keydown",this._closeByEsc),this._popup.classList.remove("opened")}}class n extends o{constructor(e,t){var s,r;super(e.popup),r=e=>{this._submitButton.textContent=e?"Сохранение...":"Сохранить"},(s="renderLoading")in this?Object.defineProperty(this,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[s]=r,this._popup=e.popup,this._form=e.form,this._inputList=Array.from(this._form.querySelectorAll(e.inputSelector)),this._submitButton=e.popup.querySelector(".submit"),this._callback=t}_getInputValues(){const e={};return this._inputList.forEach((function(t){e[t.name]=t.value})),e}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._callback(this._getInputValues())}))}closePopup(){super.closePopup(),this._form.reset()}}const i={inputSelector:".popup__input",submitButtonSelector:".submit",errorSpanSelector:".error",inactiveButtonClass:"popup__button_disabled",errorClass:"popup__error_visible"},a=document.querySelector(".popup__editform-profile"),u=document.querySelector(".profile__avatarbutton"),c=document.querySelector(".profile__editbutton"),l=document.querySelector(".profile__addbutton"),h=document.querySelector(".popup_profile"),d=document.querySelector(".profile__name"),p=document.querySelector(".profile__job"),_=document.namjob.name,m=document.namjob.job,b=document.querySelector(".grid"),g=document.querySelector(".popup_avatar"),f=document.querySelector(".popup__editformavatar"),v=document.querySelector(".popup_add"),y=document.querySelector(".popup__editform-add"),k=document.querySelector(".popup_img"),E=document.querySelector(".popup__img"),L=document.querySelector(".popup__p"),S=document.querySelector(".popup_sure"),P=document.querySelector(".popup__button-sure"),I=new n({popup:g,form:f,inputSelector:".popup__input"},(function(e){I.renderLoading(!0),x.changeAvatar(e).then((e=>{u.style.backgroundImage=`url(${e.avatar})`,I.renderLoading(!1),I.closePopup()})).catch((e=>{alert("changeAvatar\n"+e)}))}));I.setEventListeners();const w=new n({popup:h,form:a,inputSelector:".popup__input"},(function(e){w.renderLoading(!0),x.changeUserInfo(e).then((e=>{B.setUserInfo(e),w.renderLoading(!1),w.closePopup()})).catch((e=>{alert("changeUserInfo\n"+e)}))}));w.setEventListeners();const j=new n({popup:v,form:y,inputSelector:".popup__input"},(function(e){j.renderLoading(!0),x.addCard(e).then((e=>{A.creataItem(e),j.renderLoading(!1),j.closePopup()})).catch((e=>{alert("addCard\n"+e)}))}));j.setEventListeners();const C=new class extends o{constructor(e,t,s){super(e),this._bigImgPopupImg=t,this._subscibePopupImg=s}showPopup(e,t){this._subscibePopupImg.textContent=e,this._bigImgPopupImg.src=t,this._bigImgPopupImg.alt=e,super.showPopup()}}(k,E,L);C.setEventListeners();const q=new class extends o{constructor(e,t){super(e.popup),this._button=e.button,this._callback=t}setEventListeners(){super.setEventListeners(),this._button.addEventListener("click",(()=>{this._callback(this._target,this._id)}))}showPopup(e,t){this._target=e,this._id=t,super.showPopup()}}({popup:S,button:P},(function(e,t){q.closePopup(),x.deleteCard(t).then((t=>{e.remove()})).catch((e=>{alert("deleteCard\n"+e)}))}));q.setEventListeners();const U=C.showPopup.bind(C),$=q.showPopup.bind(q),B=new class{constructor(e){var t,s;s=e=>{console.log(e._id),this._avatar.style.backgroundImage=`url(${e.avatar})`,this._name.textContent=e.name,this._job.textContent=e.about,this._userId=e._id,console.log("ИД пользователя "+this._userId)},(t="setUserInfo")in this?Object.defineProperty(this,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):this[t]=s,this._avatar=e.avatar,this._name=e.name,this._job=e.job,this._userId=e.userId}getUserInfo(){return{name:this._name.textContent,job:this._job.textContent}}}({avatar:u,name:d,job:p,userId:0}),x=new class{constructor(e){var t,s;s=(e,t)=>e.likes.some((function(e){return e._id===t}))?fetch(`${this._baseUrl}cards/likes/${e._id}`,{method:"DELETE",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`))):fetch(`${this._baseUrl}cards/likes/${e._id}`,{method:"PUT",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`))),(t="likeing")in this?Object.defineProperty(this,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):this[t]=s,this._baseUrl=e.baseUrl,this._headers=e.headers}loadUserProfile(){return fetch(`${this._baseUrl}users/me`,{method:"GET",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}loadInitialCards(){return fetch(`${this._baseUrl}cards`,{method:"GET",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}changeAvatar(e){return fetch(`${this._baseUrl}users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e.avatar})}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}changeUserInfo(e){return fetch(`${this._baseUrl}users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.name,about:e.job})}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}addCard(e){return fetch(`${this._baseUrl}cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e.title,link:e.link})}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}deleteCard(e){return fetch(`${this._baseUrl}cards/${e}`,{method:"DELETE",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-20/",headers:{authorization:"30098fac-b1a4-4fba-bcbb-1d071c550463","Content-Type":"application/json"}});x.loadUserProfile().then((e=>{B.setUserInfo(e)})).catch((e=>{alert("loadUserProfile\n"+e)}));const A=new class{constructor(e,t){var s,r;r=(e,t)=>{e.title=e.name;const s=this._callback(e);this.addElement(s.createCard(),this._selector,t)},(s="creataItem")in this?Object.defineProperty(this,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[s]=r,this._callback=e,this._selector=t}addElement(e,t,s){s?t.append(e):t.prepend(e)}createStartGrid(e){e.forEach((e=>{this.creataItem(e,!0)}))}}((e=>new t(e,"#card",B._userId,U,$,x.likeing)),b);x.loadInitialCards().then((e=>{A.createStartGrid(e)})).catch((e=>{alert("loadInitialCards\n"+e)}));const T=new s(i,f);T.enableValidation();const O=new s(i,a);O.enableValidation();const V=new s(i,y);V.enableValidation(),u.addEventListener("click",(function(){T.resetError(),T.toggleButton(),I.showPopup()})),c.addEventListener("click",(function(){!function(){const e=B.getUserInfo();_.setAttribute("value",e.name),m.setAttribute("value",e.job),O.resetError(),O.toggleButton(),w.showPopup()}()})),l.addEventListener("click",(function(){V.resetError(),V.toggleButton(),j.showPopup()}))})();